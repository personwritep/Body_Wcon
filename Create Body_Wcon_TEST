// ==UserScript==
// @name         Body Wcon TEST ‚ñ∂
// @namespace    http://tampermonkey.net/
// @version      0.2
// @description  Á∑®ÈõÜÁîªÈù¢„Äå„Éá„Ç∂„Ç§„É≥ÂπÖ„ÅßË°®Á§∫„Äç„ÅÆOFFÊôÇ„Å´ÂπÖ„Ç≥„É≥„Éà„É≠„Éº„É´
// @author       Ameba Blog User
// @match        https://blog.ameba.jp/ucs/entry/srventry*
// @exclude      https://blog.ameba.jp/ucs/entry/srventrylist*
// @icon         https://www.google.com/s2/favicons?sz=64&domain=ameba.jp
// @grant        none
// ==/UserScript==


let ua=0;
let agent=window.navigator.userAgent.toLowerCase();
if(agent.indexOf('firefox')!=-1){ ua=1; } // Firefox„ÅÆÂ†¥Âêà


let editorStyle=document.querySelector('.p-editorStyle');
if(editorStyle){
    editorStyle.style.width='220px'; // Âõ∫ÂÆö„Éá„Ç∂„Ç§„É≥

    let applyStyleWidth=document.querySelector('#applyStyleWidth');
    if(applyStyleWidth){
        applyStyleWidth.addEventListener('input', function(){
            if(applyStyleWidth.checked){
                show_off(); }
            else{
                show_on(); }
        }); }}



function show_on(){
    let bwidth=localStorage.getItem('BodyWcon'); // „É¢„Éê„Ç§„É´„ÄÄ„Éá„Ç£„Çπ„Éó„É¨„Ç§ÂπÖÂÄ§ üîµ
    if(!bwidth){
        bwidth=360; }

    let cont=
        '<div id="con_container">'+
        '<span id="con_val"></span>'+
        '<input id="width_con" '+
        'type="range" min="280" value="620" step="1">'+
        '<style>'+
        '.p-editorStyle { width: 220px; }'+
        '#applyStyleWidthLabel { font-size: 0; }'+
        '#js-editorStyleQuestion, js-editorStyleBalloon { display: none; }'+
        '#con_container { display: inline-block; width: 180px; }'+
        '#con_val { display: inline-block; width: 36px; font-size: 14px; vertical-align: 3px; }'+
        '#width_con { width: calc(100% - 40px); }';

    if(ua==1){
        cont+=
            '#con_container { margin-top: -2px; }'+
            '#con_val { vertical-align: 5px; }'; }

    cont+='</style></div>';


    if(!document.querySelector('#width_con')){
        editorStyle.insertAdjacentHTML('beforeend', cont); }
    let width_con=document.querySelector('#width_con');
    let con_val=document.querySelector('#con_val');



    let editor_iframe=document.querySelector('.cke_wysiwyg_frame');
    if(editor_iframe){ // iframeË™≠Ëæº„Åø„ÅåÂÆüË°åÊù°‰ª∂
        let iframe_doc=editor_iframe.contentWindow.document;
        if(iframe_doc){
            let iframe_body=iframe_doc.querySelector('body.cke_editable');
            if(iframe_body){
                let cont_iframe='<style id="editer_width_con"></style>';
                if(!iframe_body.querySelector('#editer_width_con')){
                    iframe_body.insertAdjacentHTML('beforeend', cont_iframe); }
                let editer_width_con=iframe_doc.querySelector('#editer_width_con');

                let max_width=editor_iframe.getBoundingClientRect().width - 32;
                width_con.max=max_width;

                width_con.value=bwidth;
                con_val.textContent=bwidth;
                editer_width_con.textContent=
                    'body.cke_editable { width: '+(bwidth/1 + 16) +'px !important; }';

                width_con.addEventListener('input', function(){
                    bwidth=width_con.value;
                    con_val.textContent=bwidth;
                    editer_width_con.textContent=
                        'body.cke_editable { width: '+(bwidth/1 + 16) +'px !important; }';

                    localStorage.setItem('BodyWcon', bwidth); // Ê©üÁ®Æ„Éá„Ç£„Çπ„Éó„É¨„Ç§ÂπÖ„Çª„ÉÉ„Éà üîµ
                });
            }}}

} // show_on()




function show_off(){
    let editor_iframe=document.querySelector('.cke_wysiwyg_frame');
    if(editor_iframe){ // iframeË™≠Ëæº„Åø„ÅåÂÆüË°åÊù°‰ª∂
        let iframe_doc=editor_iframe.contentWindow.document;
        if(iframe_doc){
            let editer_width_con=iframe_doc.querySelector('#editer_width_con');
            if(editer_width_con){
                editer_width_con.remove(); }}}


    let con_container=document.querySelector('#con_container');
    if(con_container){
        con_container.remove(); }

} // show_off()
